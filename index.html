<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Live TV Feed</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
  /* Reset & Base styles */
  html, body {
    margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden;
    font-family: Arial, sans-serif; position: relative;
    transition: background 0.3s, color 0.3s;
  }
  body.light-mode {
    background: #f0f0f0; color: #000;
  }

  /* Background overlays */
  body::before {
    content: '';
    position: fixed; inset: 0; pointer-events: none; z-index: 1;
    background: radial-gradient(circle at 20% 80%, rgba(120,219,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(120,219,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(200,240,255,0.1) 0%, transparent 60%);
  }

  /* Glow effect */
  .warm-glow {
    position: fixed; inset: 0; background: radial-gradient(circle at center, rgba(255,200,150,0.08) 0%, transparent 70%);
    pointer-events: none; z-index: 2;
  }

  /* Container for channels */
  .container {
    height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth;
    position: relative; z-index: 3; padding: 0 0;
  }

  /* Channel sections */
  .channel {
    height: 100vh; width: 100vw; position: relative; scroll-snap-align: start; scroll-snap-stop: always;
    box-shadow: inset 0 0 40px rgba(100,200,255,0.2);
    transition: transform 0.5s ease, box-shadow 0.3s ease;
  }

  /* Video styles */
  video {
    width: 100%; height: 100%; object-fit: contain; background: transparent;
    opacity: 0; transition: opacity 1.4s ease;
    display: block;
  }
  video.playing { opacity: 1; }

  /* Loading overlay */
  .loading {
    position: absolute; inset: 0; background: rgba(0,0,0,0.35);
    display: flex; align-items: center; justify-content: center; font-size: 26px; opacity: 0; transition: opacity 0.6s;
    pointer-events: none; z-index: 5; color: white; text-align: center;
  }
  .loading.show { opacity: 1; pointer-events: all; }

  /* Loading text animation */
  .loading-text {
    font-family: Georgia, serif; font-weight: normal; letter-spacing: 4px; text-shadow: 0 0 20px rgba(0,255,255,0.6);
    animation: pulse 2.5s ease-in-out infinite, typing 3.5s steps(12) infinite; white-space: nowrap; overflow: hidden; border-right: 3px solid rgba(0,255,255,0.8);
  }

  @keyframes pulse {
    0%,100% { opacity: 0.7; }
    50% { opacity: 1; }
  }

  @keyframes typing {
    0% { width: 0; }
    50% { width: 140px; }
    90%,100% { width: 140px; }
  }

  /* Overlay info (LIVE, channel name, description) */
  .overlay {
    position: absolute; bottom: 20px; left: 20px; color: #fff; text-shadow: 0 0 15px rgba(0,255,255,0.8), 0 0 5px black; z-index: 4;
  }
  .live {
    background: rgba(255,0,0,0.8); padding: 4px 12px; border-radius: 8px; font-size: 12px; box-shadow: 0 0 15px rgba(255,0,0,0.6);
  }
  .name { font-size: 24px; margin-top: 8px; font-weight: bold; text-shadow: 0 0 20px rgba(100,255,255,0.9); }
  .desc { opacity: 0.9; text-shadow: 0 0 10px black; }

  /* Search Bar */
  .search-bar {
    position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
    width: 80%; max-width: 420px; background: rgba(255,255,255,0.15); backdrop-filter: blur(12px);
    padding: 10px 18px; border-radius: 0; display: flex; align-items: center; gap: 10px; z-index: 2000; box-shadow: 0 0 20px rgba(100,255,255,0.4);
    transition: opacity 0.4s;
  }
  .search-bar input {
    flex: 1; background: none; border: none; outline: none; color: #fff; font-size: 16px;
  }

  /* Popup message */
  #popup {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(5px);
  }
  #popup > div {
    background: #0f1a2b; color: #fff; padding: 26px; border-radius: 20px; max-width: 340px; width: 85%; text-align: center; box-shadow: 0 0 40px rgba(100,255,255,0.6); border: 1px solid rgba(100,255,255,0.3);
    animation: pop 0.35s ease;
  }
  .popup-warning { background: #ffcc00; box-shadow: 0 0 35px rgba(255,215,0,0.7); color: #000; }
  .popup-error { background: #ff4444; box-shadow: 0 0 35px rgba(255,0,0,0.7); }

  @keyframes pop {
    from { transform: scale(.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* Control column (vertical controls) */
  .control-column {
    position: fixed; top: 50%; right: 20px; transform: translateY(-50%);
    display: flex; flex-direction: column; gap: 12px; background: rgba(255,255,255,0.15); backdrop-filter: blur(15px);
    padding: 20px 12px; border-radius: 25px; border: 1px solid rgba(100,255,255,0.3); box-shadow: 0 0 30px rgba(0,255,255,0.4);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease; z-index: 100;
  }
  .control-column.hidden { transform: translateY(-50%) translateX( calc(100% + 20px) ); opacity: 0; pointer-events: none; }

  /* Toggle button for control column */
  #controlToggle {
    position: fixed; top: 50%; right: 20px; transform: translateY(-50%);
    width: 50px; height: 50px; background: rgba(0,0,0,0.7); backdrop-filter: blur(15px);
    border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0ff; font-size: 22px; cursor: pointer; z-index: 99; box-shadow: 0 0 20px rgba(0,255,255,0.4);
    transition: all 0.3s ease;
  }
  #controlToggle:hover { background: rgba(0, 20, 40, 0.8); transform: translateY(-50%) scale(1.1); }

  /* Control buttons */
  .control-btn {
    background: rgba(255,255,255,0.12); border: none; color: #fff; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transition: all 0.2s;
  }
  .control-btn:hover { background: rgba(255,255,255,0.22); transform: scale(1.08); }
  .control-btn.active { background: rgba(0,255,255,0.4); box-shadow: 0 0 15px rgba(0,255,255,0.6); }

  /* Volume control (hover) */
  .volume-container { position: relative; }
  .volume-slider {
    position: absolute; left: -140px; top: 50%; transform: translateY(-50%);
    width: 120px; height: 8px; appearance: none; background: rgba(255,255,255,0.2); border-radius: 4px; outline: none; opacity: 0; pointer-events: none; transition: opacity 0.3s;
  }
  .volume-container:hover .volume-slider { opacity: 1; pointer-events: all; }

  /* Slider thumb styles */
  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #0ff; cursor: pointer; box-shadow: 0 0 10px rgba(0,255,255,0.8);
  }
  .volume-slider::-moz-range-thumb {
    width: 20px; height: 20px; border-radius: 50%; background: #0ff; cursor: pointer; box-shadow: 0 0 10px rgba(0,255,255,0.8);
  }

  /* Sidebar for channels list */
  .sidebar {
    position: fixed; top: 0; left: -300px; width: 280px; height: 100%; background: rgba(10,20,35,0.95); backdrop-filter: blur(15px);
    z-index: 2001; padding: 80px 15px 20px; overflow-y: auto; transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 10px 0 40px rgba(0,0,0,0.7); border-right: 1px solid rgba(100,255,255,0.2);
  }
  .sidebar.open { left: 0; }
  .sidebar-header { color: #fff; font-size: 22px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(100,255,255,0.3); text-align: center; }

  /* Channel item styles */
  .channel-item {
    display: flex; align-items: center; padding: 12px 15px; margin-bottom: 8px; background: rgba(255,255,255,0.08); border-radius: 10px; color: #fff; cursor: pointer; transition: all 0.2s;
  }
  .channel-item:hover { background: rgba(255,255,255,0.15); transform: translateX(5px); }
  .channel-item.active { background: rgba(0,255,255,0.25); box-shadow: 0 0 15px rgba(0,255,255,0.4); }
  .channel-item .live-indicator { width: 8px; height: 8px; border-radius: 50%; background: red; margin-right: 10px; box-shadow: 0 0 8px red; }
  .channel-item .channel-name { flex: 1; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .favorite-btn { background: none; border: none; color: gold; font-size: 18px; cursor: pointer; padding: 5px; min-width: 30px; }

  /* Quality selector menu */
  .quality-menu {
    position: absolute; left: -160px; top: 50%; transform: translateY(-50%) translateX(-10px);
    background: rgba(10,20,35,0.95); backdrop-filter: blur(10px); border-radius: 10px; padding: 10px 0; min-width: 150px; box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    border: 1px solid rgba(100,255,255,0.3); opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 101;
  }
  .quality-menu.show { opacity: 1; pointer-events: all; }
  .quality-item {
    padding: 12px 20px; color: #fff; cursor: pointer; transition: background 0.2s; white-space: nowrap;
  }
  .quality-item:hover { background: rgba(255,255,255,0.1); }
  .quality-item.active { background: rgba(0,255,255,0.3); color: #0ff; }

  /* Stream info overlay */
  .stream-info {
    position: fixed; top: 80px; right: 20px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); padding: 12px 18px; border-radius: 10px; color: #0ff; font-family: monospace; font-size: 12px; z-index: 99;
    opacity: 0; transition: opacity 0.3s; max-width: 200px; border: 1px solid rgba(0,255,255,0.3);
  }
  .stream-info.show { opacity: 1; }

  /* Theater mode overlay (full screen) */
  .theater-mode {
    position: fixed; inset: 0; background: #000; z-index: 99; display: none; align-items: center; justify-content: center; }
  .theater-mode.active { display: flex; }
  .theater-video {
    width: 100%; height: 100%; object-fit: cover; background: transparent; }
  /* Landscape Mode overlay (rotated) */
  .landscape-mode {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 9998; display: none; flex-direction: column; align-items:center; justify-content:center;
  }
  #landscapeContainer {
    width: 100vh; height: 100vw; transform: rotate(90deg); transform-origin: top left; margin-top: -50%; margin-left: -50%;
  }
  #landscapeContainer video {
    width: 100%; height: 100%; object-fit: contain;
  }
  #landscapeOverlay {
    position: absolute; top: 20px; left: 20px; color: #fff; text-shadow: 0 0 15px rgba(0,255,255,0.8), 0 0 5px black; z-index: 4;
  }
  /* Controls for landscape mode (rotated) */
  .landscape-controls {
    position: fixed; bottom: 20px; right: 20px; display: flex; gap: 12px; background: rgba(0,0,0,0.7); border-radius: 20px; padding: 15px; box-shadow: 0 0 30px rgba(0,255,255,0.4); z-index: 9999;
    transform: rotate(-90deg) translateX(50%) ; transform-origin: bottom right;
  }
  .landscape-control-btn {
    width: 45px; height: 45px; background: rgba(255,255,255,0.12); border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: all 0.2s;
  }
  .landscape-control-btn:hover { background: rgba(255,255,255,0.22); transform: scale(1.08); }

  /* Rotate hint for mobile */
  .rotate-hint {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; color: #fff; text-align: center; z-index: 10000; padding: 20px;
  }
  .rotate-hint.show { display: flex; }
  .rotate-hint i {
    font-size: 80px; margin-bottom: 30px; color: #0ff; animation: rotatePhone 2s ease-in-out infinite;
  }
  @keyframes rotatePhone {
    0%,100% { transform: rotate(0deg); }
    50% { transform: rotate(90deg); }
  }

  /* Sleep Timer Panel */
  #sleepTimer {
    position: fixed; top: 50%; left:50%; transform: translate(-50%, -50%); background: rgba(10,20,35,0.95); backdrop-filter: blur(15px); padding: 30px; border-radius: 20px; color: #fff; z-index: 2002; display: none; min-width: 280px; box-shadow: 0 0 50px rgba(0,255,255,0.4); border: 1px solid rgba(0,255,255,0.3);
  }
  #sleepTimer.show { display: flex; flex-direction: column; }
  .timer-options { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; justify-content: center; }
  .timer-btn {
    padding: 10px 15px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: #fff; cursor: pointer; transition: all 0.2s;
  }
  .timer-btn:hover { background: rgba(0,255,255,0.3); }
  .timer-btn.active { background: rgba(0,255,255,0.5); box-shadow: 0 0 15px rgba(0,255,255,0.5); }
  #customTimer { padding: 10px; border-radius: 8px; border: none; outline: none; width: 100px; }
  #setCustomTimer { padding: 10px 20px; background: rgba(255,255,255,0.2); border: none; border-radius: 8px; cursor: pointer; }
  #setCustomTimer:hover { background: rgba(255,255,255,0.4); }

  /* Fullscreen/Landscape toggle button */
  #fullscreenLandscapeBtn {
    background: rgba(255,255,255,0.12); border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transition: all 0.2s;
  }
  #fullscreenLandscapeBtn:hover { background: rgba(255,255,255,0.22); transform: scale(1.08); }

  /* Stream info overlay */
  #streamInfo {
    position: fixed; top: 80px; right: 20px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); padding: 12px 18px; border-radius: 10px; color: #0ff; font-family: monospace; font-size: 12px; max-width: 200px; opacity: 0; transition: opacity 0.3s; border: 1px solid rgba(0,255,255,0.3); z-index: 99;
  }
  #streamInfo.show { opacity: 1; }

  /* Hidden controls button */
  #hideControlsBtn {
    position: fixed; bottom: 20px; right: 20px; background: rgba(255,255,255,0.12); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
  }
  #hideControlsBtn:hover { background: rgba(255,255,255,0.22); transform: scale(1.08); }

  /* Responsive adjustments */
  @media(max-width:768px){
    /* Adjust controls for mobile if needed */
  }

</style>
</head>
<body>

<div class="warm-glow"></div>

<!-- Popup message -->
<div id="popup">
  <div>
    <h2 id="pTitle" style="margin-top:0;"></h2>
    <p id="pText" style="opacity:.9;"></p>
    <button id="pBtn" style="margin-top:14px;padding:10px 24px;background:#0ff;color:#000;border:none;border-radius:14px;font-weight:bold;cursor:pointer;box-shadow:0 0 15px rgba(0,255,255,0.8);">Close</button>
  </div>
</div>

<!-- Rotate hint for mobile -->
<div class="rotate-hint" id="rotateHint">
  <i class="fas fa-rotate-right"></i>
  <h2>Rotate Your Device</h2>
  <p>Turn on device rotation<br> to switch to <br>landscape mode</p>
  <p style="margin-top: 20px; font-size: 14px; opacity: 0.7;">Or tap "Exit" to return to portrait</p>
</div>

<!-- Search Bar -->
<div class="search-bar" id="searchBar" aria-hidden="false">
  üîç
  <input id="searchInput" placeholder="Search channels..." aria-label="Search channels" />
</div>

<!-- Control Column Toggle -->
<div class="control-column-toggle" id="controlToggle" aria-label="Toggle controls">
  <i class="fas fa-chevron-left"></i>
</div>

<!-- Vertical Controls -->
<div class="control-column" id="controlColumn">
  <!-- Volume Control -->
  <div class="volume-container">
    <button class="control-btn" id="volumeBtn" aria-label="Volume control">
      <i class="fas fa-volume-up"></i>
    </button>
    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="1" aria-label="Volume slider" />
  </div>

  <!-- Quality Selector -->
  <div class="quality-container" style="margin-top:10px;">
    <button class="control-btn" id="qualityBtn" aria-label="Select quality">
      <i class="fas fa-tachometer-alt"></i>
    </button>
    <div class="quality-menu" id="qualityMenu">
      <div class="quality-item" data-quality="auto">Auto</div>
      <div class="quality-item" data-quality="1080">1080p</div>
      <div class="quality-item" data-quality="720">720p</div>
      <div class="quality-item" data-quality="480">480p</div>
      <div class="quality-item" data-quality="360">360p</div>
    </div>
  </div>

  <!-- Fullscreen / Landscape Button -->
  <button class="control-btn" id="fullscreenLandscapeBtn" aria-label="Fullscreen / Landscape">
    <i class="fas fa-expand" id="fullscreenIcon"></i>
  </button>

  <!-- Theater Mode -->
  <button class="control-btn" id="theaterBtn" aria-label="Theater Mode">
    <i class="fas fa-film"></i>
  </button>

  <!-- Stream Info -->
  <button class="control-btn" id="infoBtn" aria-label="Stream info">
    <i class="fas fa-info-circle"></i>
  </button>

  <!-- Sleep Timer -->
  <button class="control-btn" id="sleepBtn" aria-label="Sleep Timer">
    <i class="fas fa-moon"></i>
  </button>

  <!-- Share Channel -->
  <button class="control-btn" id="shareBtn" aria-label="Share channel">
    <i class="fas fa-share-alt"></i>
  </button>

  <!-- Favorite -->
  <button class="control-btn" id="favoriteBtn" aria-label="Favorite">
    <i class="far fa-star"></i>
  </button>

  <!-- Channel List Sidebar -->
  <button class="control-btn" id="sidebarBtn" aria-label="Channel list">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Hide Controls Button -->
  <button class="hide-controls-btn" id="hideControlsBtn" aria-label="Hide controls">
    <i class="fas fa-chevron-right"></i>
  </button>
</div>

<!-- Stream Info Overlay -->
<div class="stream-info" id="streamInfo" aria-hidden="true">
  <div>Bitrate: <span id="bitrate">--</span></div>
  <div>Resolution: <span id="resolution">--</span></div>
  <div>Buffer: <span id="buffer">--</span></div>
  <div>FPS: <span id="fps">--</span></div>
</div>

<!-- Theater Mode Overlay -->
<div class="theater-mode" id="theaterMode"></div>

<!-- Landscape Mode -->
<div class="landscape-mode" id="landscapeMode">
  <div class="landscape-container" id="landscapeContainer"></div>
  <div class="landscape-overlay" id="landscapeChannelInfo">
    <span class="live">LIVE</span>
    <div class="name" id="landscapeChannelName">Channel Name</div>
    <div class="desc" id="landscapeChannelDesc">Channel Description</div>
  </div>
  <div class="landscape-controls" id="landscapeControls">
    <button class="landscape-control-btn" id="landscapeVolumeBtn" aria-label="Volume">
      <i class="fas fa-volume-up"></i>
    </button>
    <button class="landscape-control-btn" id="landscapeExitBtn" aria-label="Exit Landscape">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>

<!-- Sleep Timer Panel -->
<div id="sleepTimer" aria-hidden="true">
  <h3 style="margin-top:0;text-align:center;">Sleep Timer</h3>
  <div class="timer-options">
    <button class="timer-btn" data-minutes="5">5 min</button>
    <button class="timer-btn" data-minutes="15">15 min</button>
    <button class="timer-btn" data-minutes="30">30 min</button>
    <button class="timer-btn" data-minutes="60">60 min</button>
    <button class="timer-btn" data-minutes="90">90 min</button>
  </div>
  <div style="display:flex;gap:10px;margin-top:15px;">
    <input type="number" id="customTimer" placeholder="Custom minutes" style="flex:1;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:white;">
    <button class="timer-btn" id="setCustomTimer">Set</button>
  </div>
  <div style="text-align:center;margin-top:20px;">
    <button class="timer-btn" id="cancelTimer" style="background:rgba(255,50,50,0.7);">Cancel Timer</button>
  </div>
  <div id="sleepCountdown" style="margin-top:10px;font-size:14px;color:#fff;text-align:center;"></div>
</div>

<!-- Sidebar for channels -->
<div class="sidebar" id="sidebar" aria-hidden="true">
  <div class="sidebar-header">
    <i class="fas fa-satellite-dish" style="margin-right:10px;"></i> Channels
  </div>
  <div id="channelList"></div>
</div>

<!-- Main Content -->
<div class="container" id="feed"></div>

<!-- Dark Mode Toggle Button -->
<button id="modeToggle" aria-label="Toggle Dark/Light Mode" style="position:fixed; top:10px; right:70px; z-index:3000; background:#0ff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">üåì</button>

<!-- Fullscreen/Landscape toggle button -->
<button id="fullscreenLandscapeBtn" aria-label="Fullscreen / Landscape" style="position:fixed; top:10px; right:20px; z-index:3000; background:#0ff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">
  <i class="fas fa-expand" id="fullscreenIcon"></i>
</button>

<!-- Control toggle button -->
<div id="controlToggle" style="position:fixed; top:50%; right:20px; transform:translateY(-50%); z-index:3000; cursor:pointer; background:#000; padding:10px; border-radius:50%; box-shadow:0 0 10px rgba(0,255,255,0.5);">
  <i class="fas fa-chevron-left" style="color:#0ff; font-size:20px;"></i>
</div>

<!-- Hidden controls for toggling -->
<script>
/* JavaScript Section: Enhancements & Logic */

const feed = document.getElementById('feed');
let channels = [], favorites = JSON.parse(localStorage.getItem('tvFavorites')) || [];
let activeVideo = null, activeChannelIndex = 0;
let sleepTimer = null, countdownInterval = null;
let landscapeMode = false;
let controlColumnVisible = true;
let controlAutoHideTimeout;
let originalVideo = null;
const streamInfo = document.getElementById('streamInfo');
const rotateHint = document.getElementById('rotateHint');
const popup = document.getElementById('popup');
const body = document.body;
const controlColumn = document.getElementById('controlColumn');
const controlToggle = document.getElementById('controlToggle');
const sleepPanel = document.getElementById('sleepTimer');
const landscapeContainer = document.getElementById('landscapeContainer');

// Load channels.json
fetch('channels.json')
  .then(res => res.json())
  .then(data => {
    channels = data;
    renderChannels();
    initControls();
    autoHideControls();
  })
  .catch(console.error);

// Render channels
function renderChannels() {
  feed.innerHTML = '';
  channels.forEach((channel, index) => {
    const section = document.createElement('section');
    section.className = 'channel';
    section.id = `channel-${index}`;
    section.innerHTML = `
      <video playsinline data-url="${channel.url}" poster="${channel.poster || ''}"></video>
      <div class="loading">
        <div class="loading-text">Loading........</div>
      </div>
      <div class="overlay">
        <span class="live">LIVE</span>
        <div class="name">${channel.name}</div>
        <div class="desc">${channel.desc || ''}</div>
      </div>`;
    feed.appendChild(section);
    section._hls = null;
    observeSection(section);
  });
  updateSidebar();
}

// Intersection observer for lazy loading and focus
function observeSection(section) {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const video = section.querySelector('video');
      const loading = section.querySelector('.loading');
      let hls = section._hls;

      if (entry.intersectionRatio >= 0.3) {
        // Load stream
        if (!hls && video.dataset.url) {
          if (Hls.isSupported()) {
            hls = new Hls({ liveSyncDurationCount: 2, maxBufferLength: 10 });
            hls.loadSource(video.dataset.url);
            hls.attachMedia(video);
            section._hls = hls;

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
              video.play().catch(console.log);
            });
            hls.on(Hls.Events.ERROR, (event, data) => {
              if (data.fatal) {
                loading.innerHTML = '<div style="font-size:20px;">Stream error<br>Try scrolling away and back</div>';
              }
            });
            hls.on(Hls.Events.FRAG_LOADED, () => updateStreamInfo(hls, video));
          } else {
            // Native fallback
            video.src = video.dataset.url;
            video.load();
            video.play().catch(console.log);
          }
        }
        // Play video if sufficiently visible
        if (entry.intersectionRatio >= 0.85 && video !== activeVideo) {
          // Pause other videos
          document.querySelectorAll('video').forEach(v => {
            v.pause();
            v.classList.remove('playing');
            v.muted = true;
          });
          // Play current
          video.muted = false;
          video.volume = parseFloat(localStorage.getItem('tvVolume') || '1');
          video.play().then(() => {
            video.classList.add('playing');
            loading.classList.remove('show');
            updateActiveChannel(section);
          });
        }
      } else {
        // Unload stream
        if (section._hls) section._hls.stopLoad();
        video.pause();
        video.classList.remove('playing');
        if (video === activeVideo && !landscapeMode) {
          activeVideo = null;
        }
        loading.classList.remove('show');
      }
    });
  }, { threshold: [0, 0.3, 0.85] });
  observer.observe(section);
}

// Update active channel info
function updateActiveChannel(section) {
  activeChannelIndex = Array.from(feed.children).indexOf(section);
  updateSidebar();
  if (landscapeMode) {
    document.getElementById('landscapeChannelName').textContent = channels[activeChannelIndex].name;
    document.getElementById('landscapeChannelDesc').textContent = channels[activeChannelIndex].desc || '';
  }
  // Update favorite icon
  updateFavoriteIcon();
}

// Update stream info display
function updateStreamInfo(hls, video) {
  if (!hls || !document.getElementById('infoBtn').classList.contains('active')) return;
  const level = hls.levels[hls.currentLevel] || {};
  document.getElementById('bitrate').textContent = level.bitrate ? Math.round(level.bitrate/1000)+' kbps' : '--';
  document.getElementById('resolution').textContent = level.height ? level.height + 'p' : '--';

  const buffered = video.buffered.length ? (video.buffered.end(0) - video.buffered.start(0)) : 0;
  document.getElementById('buffer').textContent = buffered.toFixed(1) + 's';

  if (!video._lastTime) {
    video._lastTime = video.currentTime;
    video._frameCount = 0;
    setTimeout(() => {
      const elapsed = video.currentTime - video._lastTime;
      const fps = video._frameCount / elapsed;
      document.getElementById('fps').textContent = fps.toFixed(1);
      video._lastTime = video._frameCount = 0;
    }, 1000);
  }
  video._frameCount++;
}

// Sidebar rendering
function updateSidebar() {
  const list = document.getElementById('channelList');
  list.innerHTML = '';
  channels.forEach((channel, index) => {
    const isFav = favorites.some(f => f.url === channel.url);
    const item = document.createElement('div');
    item.className = `channel-item ${index === activeChannelIndex ? 'active' : ''}`;
    item.innerHTML = `
      <div class="live-indicator"></div>
      <div class="channel-name">${channel.name}</div>
      <button class="favorite-btn" data-index="${index}">
        <i class="${isFav ? 'fas' : 'far'} fa-star"></i>
      </button>`;
    item.addEventListener('click', () => {
      // Scroll into view
      const sections = document.querySelectorAll('.channel');
      if (sections[index]) {
        sections[index].scrollIntoView({ behavior: 'smooth' });
        toggleSidebar(false);
      }
    });
    list.appendChild(item);
  });
  // favorite button handler
  document.querySelectorAll('.favorite-btn').forEach(btn => {
    btn.onclick = (e) => {
      e.stopPropagation();
      const idx = parseInt(btn.dataset.index);
      toggleFavorite(idx);
    };
  });
}

// Toggle favorite
function toggleFavorite(index) {
  const channel = channels[index];
  const favIdx = favorites.findIndex(f => f.url === channel.url);
  if (favIdx === -1) {
    favorites.push(channel);
  } else {
    favorites.splice(favIdx,1);
  }
  localStorage.setItem('tvFavorites', JSON.stringify(favorites));
  updateSidebar();
  updateFavoriteIcon();
}

function updateFavoriteIcon() {
  const btn = document.getElementById('favoriteBtn');
  if (favorites.some(f => f.url === channels[activeChannelIndex]?.url))
    btn.innerHTML = '<i class="fas fa-star"></i>';
  else
    btn.innerHTML = '<i class="far fa-star"></i>';
}

// Toggle sidebar
function toggleSidebar(open = null) {
  const sidebar = document.getElementById('sidebar');
  if (open === null) {
    sidebar.classList.toggle('open');
  } else {
    sidebar.classList.toggle('open', open);
  }
}

// Toggle control column
function toggleControlColumn() {
  controlColumn.classList.toggle('hidden');
  controlColumnVisible = !controlColumn.classList.contains('hidden');
  if (!controlColumn.classList.contains('hidden')) {
    autoHideControls();
  } else {
    clearTimeout(controlAutoHideTimeout);
  }
}

// Auto-hide controls after inactivity
function autoHideControls() {
  clearTimeout(controlAutoHideTimeout);
  controlAutoHideTimeout = setTimeout(() => {
    if (controlColumnVisible) toggleControlColumn();
  }, 5000);
}

// Show controls temporarily
function showControls() {
  if (controlColumn.classList.contains('hidden')) {
    toggleControlColumn();
  }
  autoHideControls();
}

// Fullscreen/Landscape toggle
async function toggleFullscreenLandscape() {
  if (!document.fullscreenElement) {
    await document.documentElement.requestFullscreen();
    if (window.innerHeight > window.innerWidth) {
      enterLandscapeMode();
    }
    document.getElementById('fullscreenIcon').className = 'fas fa-compress';
  } else {
    if (landscapeMode) exitLandscapeMode();
    await document.exitFullscreen();
    document.getElementById('fullscreenIcon').className = 'fas fa-expand';
  }
}

// Enter landscape mode
function enterLandscapeMode() {
  if (!activeVideo) return;
  landscapeMode = true;
  const channel = channels[activeChannelIndex];

  // Clone video
  const landscapeVideo = activeVideo.cloneNode(true);
  landscapeVideo.id = 'landscapeVideo';

  // Attach media
  if (activeVideo._hls) {
    activeVideo._hls.detachMedia();
    activeVideo._hls.attachMedia(landscapeVideo);
  } else {
    landscapeVideo.src = activeVideo.src;
  }
  landscapeVideo.play();

  // Append to container
  landscapeContainer.innerHTML = '';
  landscapeContainer.appendChild(landscapeVideo);

  // Update info overlay
  document.getElementById('landscapeChannelName').textContent = channel.name;
  document.getElementById('landscapeChannelDesc').textContent = channel.desc || '';

  document.getElementById('landscapeMode').classList.add('active');

  // Hide main UI
  document.getElementById('feed').style.opacity = '0';
  controlColumn.classList.add('hidden');
  controlToggle.classList.add('hidden');

  // Show rotate hint if in portrait
  if (window.innerHeight > window.innerWidth) {
    setTimeout(() => { rotateHint.classList.add('show'); }, 1000);
  }
}

// Exit landscape mode
function exitLandscapeMode() {
  if (!landscapeMode || !activeVideo) return;
  landscapeMode = false;

  // Transfer media back
  const landscapeVideo = document.getElementById('landscapeVideo');

  if (activeVideo._hls && landscapeVideo) {
    activeVideo._hls.detachMedia();
    activeVideo._hls.attachMedia(activeVideo);
  }
  // Restore playback state
  activeVideo.currentTime = landscapeVideo?.currentTime || activeVideo.currentTime;
  activeVideo.volume = landscapeVideo?.volume || activeVideo.volume;
  activeVideo.muted = landscapeVideo?.muted || activeVideo.muted;
  activeVideo.play();

  // Remove landscape video
  if (landscapeVideo) {
    landscapeVideo.pause();
    landscapeVideo.src = '';
    landscapeVideo.remove();
  }

  document.getElementById('landscapeMode').classList.remove('active');
  rotateHint.classList.remove('show');
  document.getElementById('feed').style.opacity = '1';
  controlToggle.classList.remove('hidden');
}

// Search functionality
const searchInput = document.getElementById('searchInput');
const searchBar = document.getElementById('searchBar');

searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim().toLowerCase();
  const filtered = channels.filter(c => c.name.toLowerCase().includes(q) || (c.desc && c.desc.toLowerCase().includes(q)));
  renderChannels(filtered);
});

// Toggle dark/light mode
document.getElementById('modeToggle').addEventListener('click', () => {
  document.body.classList.toggle('light-mode');
});

// Toggle control column
document.getElementById('controlToggle').addEventListener('click', () => {
  toggleControlColumn();
});

// Hide controls button
document.getElementById('hideControlsBtn').addEventListener('click', () => {
  toggleControlColumn();
});

// Volume control
const volumeSlider = document.getElementById('volumeSlider');
const volumeBtn = document.getElementById('volumeBtn');

volumeSlider.value = localStorage.getItem('tvVolume') || '1';

volumeSlider.addEventListener('input', () => {
  const vol = parseFloat(volumeSlider.value);
  if (activeVideo) {
    activeVideo.volume = vol;
    localStorage.setItem('tvVolume', vol);
    updateVolumeIcon(vol);
  }
});

volumeBtn.addEventListener('click', () => {
  if (activeVideo) {
    if (activeVideo.volume > 0) {
      activeVideo.volume = 0;
      volumeSlider.value = '0';
    } else {
      activeVideo.volume = 1;
      volumeSlider.value = '1';
    }
    localStorage.setItem('tvVolume', activeVideo.volume);
    updateVolumeIcon(activeVideo.volume);
  }
});

function updateVolumeIcon(vol) {
  if (vol === 0) {
    volumeBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
  } else if (vol < 0.5) {
    volumeBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
  } else {
    volumeBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
  }
}

// Quality selector
const qualityBtn = document.getElementById('qualityBtn');
const qualityMenu = document.getElementById('qualityMenu');

qualityBtn.onclick = () => {
  qualityMenu.classList.toggle('show');
};

document.querySelectorAll('.quality-item').forEach(item => {
  item.onclick = () => {
    document.querySelectorAll('.quality-item').forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    if (activeVideo) {
      const section = activeVideo.closest('.channel');
      const hls = section._hls;
      if (hls) {
        const quality = item.dataset.quality;
        if (quality === 'auto') {
          hls.currentLevel = -1;
        } else {
          const levelIndex = hls.levels.findIndex(l => l.height == quality);
          if (levelIndex !== -1) hls.currentLevel = levelIndex;
        }
      }
    }
    qualityMenu.classList.remove('show');
  };
});

// Close quality menu on outside click
document.addEventListener('click', (e) => {
  if (!e.target.closest('#qualityBtn') && !e.target.closest('#qualityMenu')) {
    document.getElementById('qualityMenu').classList.remove('show');
  }
});

// Fullscreen / Landscape
document.getElementById('fullscreenLandscapeBtn').onclick = () => {
  toggleFullscreenLandscape();
};

// Landscape mode controls
document.getElementById('landscapeExitBtn').onclick = () => {
  if (document.fullscreenElement) document.exitFullscreen();
  if (landscapeMode) exitLandscapeMode();
};

document.getElementById('landscapeVolumeBtn').onclick = () => {
  const landscapeVideo = document.getElementById('landscapeVideo');
  if (landscapeVideo) {
    if (landscapeVideo.volume > 0) {
      landscapeVideo.volume = 0;
    } else {
      landscapeVideo.volume = 1;
    }
  }
};

// Stream info toggle
const infoBtn = document.getElementById('infoBtn');
infoBtn.onclick = () => {
  infoBtn.classList.toggle('active');
  document.getElementById('streamInfo').classList.toggle('show');
  document.getElementById('streamInfo').setAttribute('aria-hidden', String(!document.getElementById('streamInfo').classList.contains('show')));
};

// Sleep timer
const sleepBtn = document.getElementById('sleepBtn');
const sleepPanel = document.getElementById('sleepTimer');
const cancelTimerBtn = document.getElementById('cancelTimer');

sleepBtn.onclick = () => {
  sleepPanel.classList.toggle('show');
};

document.querySelectorAll('.timer-btn[data-minutes]').forEach(btn => {
  btn.onclick = () => {
    setSleepTimer(parseInt(btn.dataset.minutes));
    sleepPanel.classList.remove('show');
  };
});

document.getElementById('setCustomTimer').onclick = () => {
  const val = parseInt(document.getElementById('customTimer').value);
  if (val > 0) setSleepTimer(val);
  sleepPanel.classList.remove('show');
};

document.getElementById('cancelTimer').onclick = () => {
  clearTimeout(sleepTimer);
  sleepTimer = null;
  clearInterval(countdownInterval);
  document.getElementById('sleepCountdown').textContent = '';
  showNotification('Sleep timer canceled');
};

function setSleepTimer(minutes) {
  clearTimeout(sleepTimer);
  clearInterval(countdownInterval);
  let secondsLeft = minutes * 60;
  sleepTimer = setTimeout(() => {
    if (activeVideo) {
      activeVideo.pause();
      showNotification(`Sleep timer: Player paused after ${minutes} minutes`);
    }
  }, minutes * 60000);
  // Countdown display
  document.getElementById('sleepCountdown').textContent = `Time remaining: ${minutes} min`;
  countdownInterval = setInterval(() => {
    secondsLeft--;
    const m = Math.floor(secondsLeft/60);
    const s = secondsLeft % 60;
    document.getElementById('sleepCountdown').textContent = `Time remaining: ${m}m ${s}s`;
    if (secondsLeft <= 0) {
      clearInterval(countdownInterval);
    }
  }, 1000);
}

// Share
document.getElementById('shareBtn').onclick = () => {
  if (navigator.share && channels[activeChannelIndex]) {
    const ch = channels[activeChannelIndex];
    navigator.share({ title: `Watch ${ch.name} Live`, text: ch.desc, url: window.location.href + '#channel-' + activeChannelIndex });
  } else {
    const ch = channels[activeChannelIndex];
    navigator.clipboard.writeText(`Check out ${ch.name}: ${window.location.href}#channel-${activeChannelIndex}`);
    showNotification('Link copied to clipboard!');
  }
};

// Favorite toggle button
document.getElementById('favoriteBtn').onclick = () => {
  toggleFavorite(activeChannelIndex);
};

function toggleFavorite(index) {
  const channel = channels[index];
  const favIdx = favorites.findIndex(f => f.url === channel.url);
  if (favIdx === -1) favorites.push(channel);
  else favorites.splice(favIdx,1);
  localStorage.setItem('tvFavorites', JSON.stringify(favorites));
  updateSidebar();
  updateFavoriteIcon();
}

// Sidebar toggle
document.getElementById('sidebarBtn').onclick = () => toggleSidebar();

// Fullscreen / Landscape
async function toggleFullscreenLandscape() {
  if (!document.fullscreenElement) {
    await document.documentElement.requestFullscreen();
    if (window.innerHeight > window.innerWidth) {
      enterLandscapeMode();
    }
    document.getElementById('fullscreenIcon').className = 'fas fa-compress';
  } else {
    if (landscapeMode) exitLandscapeMode();
    await document.exitFullscreen();
    document.getElementById('fullscreenIcon').className = 'fas fa-expand';
  }
}

// Enter landscape mode
function enterLandscapeMode() {
  if (!activeVideo) return;
  landscapeMode = true;
  const channel = channels[activeChannelIndex];

  // Clone video
  const landscapeVideo = activeVideo.cloneNode(true);
  landscapeVideo.id = 'landscapeVideo';
  landscapeVideo.style.objectFit = 'contain';
  landscapeVideo.volume = activeVideo.volume;

  // Attach media
  if (activeVideo._hls && landscapeVideo) {
    activeVideo._hls.detachMedia();
    activeVideo._hls.attachMedia(landscapeVideo);
  } else {
    landscapeVideo.src = activeVideo.src;
  }
  landscapeVideo.play();

  // Append to container
  landscapeContainer.innerHTML = '';
  landscapeContainer.appendChild(landscapeVideo);

  // Update info overlay
  document.getElementById('landscapeChannelName').textContent = channel.name;
  document.getElementById('landscapeChannelDesc').textContent = channel.desc || '';

  document.getElementById('landscapeMode').classList.add('active');

  // Hide main UI
  document.getElementById('feed').style.opacity = '0';
  controlColumn.classList.add('hidden');
  controlToggle.classList.add('hidden');

  // Show rotate hint if in portrait
  if (window.innerHeight > window.innerWidth) {
    rotateHint.classList.add('show');
  }
}

// Exit landscape mode
function exitLandscapeMode() {
  if (!landscapeMode || !activeVideo) return;
  landscapeMode = false;

  const landscapeVideo = document.getElementById('landscapeVideo');

  if (activeVideo._hls && landscapeVideo) {
    activeVideo._hls.detachMedia();
    activeVideo._hls.attachMedia(activeVideo);
  }
  // Transfer playback state
  activeVideo.currentTime = landscapeVideo?.currentTime || activeVideo.currentTime;
  activeVideo.volume = landscapeVideo?.volume || activeVideo.volume;
  activeVideo.muted = landscapeVideo?.muted || activeVideo.muted;
  activeVideo.play();

  // Remove landscape video
  if (landscapeVideo) {
    landscapeVideo.pause();
    landscapeVideo.src = '';
    landscapeVideo.remove();
  }

  document.getElementById('landscapeMode').classList.remove('active');
  rotateHint.classList.remove('show');
  document.getElementById('feed').style.opacity = '1';
  controlToggle.classList.remove('hidden');
}

// Show notification
function showNotification(message) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position:fixed; top:80px; left:50%; transform:translateX(-50%);
    background:rgba(0,20,40,0.9); color:#0ff; padding:12px 24px; border-radius:30px; z-index:9999;
    backdrop-filter:blur(10px); border:1px solid rgba(0,255,255,0.3); box-shadow:0 5px 25px rgba(0,255,255,0.3);
    animation: fadeInOut 3s ease;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 3000);
}

// Animation for notification
const styleSheet = document.createElement('style');
styleSheet.innerHTML = `
@keyframes fadeInOut {
  0%,100% { opacity:0; transform:translateX(-50%) translateY(-20px); }
  20%,80% { opacity:1; transform:translateX(-50%) translateY(0); }
}`;
document.head.appendChild(styleSheet);

// Show/hide rotate hint
window.addEventListener('orientationchange', () => {
  setTimeout(() => {
    if (window.innerHeight > window.innerWidth && !landscapeMode) {
      rotateHint.classList.add('show');
    } else {
      rotateHint.classList.remove('show');
    }
  }, 300);
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (landscapeMode) exitLandscapeMode();
    if (document.fullscreenElement) document.exitFullscreen();
  }
  if (e.key === 'f') { toggleFullscreenLandscape(); }
  if (e.key === 'l') { toggleLandscapeMode(); }
});

// Toggle landscape mode directly
function toggleLandscapeMode() {
  if (landscapeMode) exitLandscapeMode();
  else toggleFullscreenLandscape();
}

// Initialize controls
function initControls() {
  // Toggle controls button
  document.getElementById('controlToggle').onclick = () => {
    toggleControlColumn();
  };

  // Hide controls
  document.getElementById('hideControlsBtn').onclick = () => {
    toggleControlColumn();
  };

  // Volume
  const volSlider = document.getElementById('volumeSlider');
  const volBtn = document.getElementById('volumeBtn');
  volSlider.value = localStorage.getItem('tvVolume') || '1';

  volSlider.oninput = () => {
    const vol = parseFloat(volSlider.value);
    if (activeVideo) {
      activeVideo.volume = vol;
      localStorage.setItem('tvVolume', vol);
      updateVolumeIcon(vol);
    }
  };

  volBtn.onclick = () => {
    if (activeVideo) {
      if (activeVideo.volume > 0) {
        activeVideo.volume = 0;
        volSlider.value = '0';
      } else {
        activeVideo.volume = 1;
        volSlider.value = '1';
      }
      localStorage.setItem('tvVolume', activeVideo.volume);
      updateVolumeIcon(activeVideo.volume);
    }
  };

  // Quality menu
  const qBtn = document.getElementById('qualityBtn');
  qBtn.onclick = () => {
    document.getElementById('qualityMenu').classList.toggle('show');
  };
  document.querySelectorAll('.quality-item').forEach(item => {
    item.onclick = () => {
      document.querySelectorAll('.quality-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      if (activeVideo) {
        const section = activeVideo.closest('.channel');
        const hls = section._hls;
        if (hls) {
          const quality = item.dataset.quality;
          if (quality === 'auto') {
            hls.currentLevel = -1;
          } else {
            const levelIdx = hls.levels.findIndex(l => l.height == quality);
            if (levelIdx !== -1) hls.currentLevel = levelIdx;
          }
        }
      }
      document.getElementById('qualityMenu').classList.remove('show');
    };
  });
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#qualityBtn') && !e.target.closest('#qualityMenu')) {
      document.getElementById('qualityMenu').classList.remove('show');
    }
  });

  // Fullscreen / Landscape
  document.getElementById('fullscreenLandscapeBtn').onclick = () => {
    toggleFullscreenLandscape();
  };

  // Landscape controls
  document.getElementById('landscapeExitBtn').onclick = () => {
    if (document.fullscreenElement) document.exitFullscreen();
    if (landscapeMode) exitLandscapeMode();
  };
  document.getElementById('landscapeVolumeBtn').onclick = () => {
    const v = document.getElementById('landscapeVideo');
    if (v) {
      if (v.volume > 0) { v.volume = 0; }
      else { v.volume = 1; }
    }
  };

  // Stream info toggle
  document.getElementById('infoBtn').onclick = () => {
    document.getElementById('infoBtn').classList.toggle('active');
    document.getElementById('streamInfo').classList.toggle('show');
    document.getElementById('streamInfo').setAttribute('aria-hidden', String(!document.getElementById('streamInfo').classList.contains('show')));
  };

  // Sleep Timer
  document.getElementById('sleepBtn').onclick = () => {
    sleepPanel.classList.toggle('show');
  };
  document.querySelectorAll('.timer-btn[data-minutes]').forEach(btn => {
    btn.onclick = () => {
      setSleepTimer(parseInt(btn.dataset.minutes));
      sleepPanel.classList.remove('show');
    };
  });
  document.getElementById('setCustomTimer').onclick = () => {
    const val = parseInt(document.getElementById('customTimer').value);
    if (val > 0) setSleepTimer(val);
    sleepPanel.classList.remove('show');
  };
  document.getElementById('cancelTimer').onclick = () => {
    clearTimeout(sleepTimer);
    sleepTimer = null;
    clearInterval(countdownInterval);
    document.getElementById('sleepCountdown').textContent = '';
    showNotification('Sleep timer canceled');
  };

  // Share
  document.getElementById('shareBtn').onclick = () => {
    if (navigator.share && channels[activeChannelIndex]) {
      const ch = channels[activeChannelIndex];
      navigator.share({ title: `Watch ${ch.name} Live`, text: ch.desc, url: window.location.href + '#channel-' + activeChannelIndex });
    } else {
      const ch = channels[activeChannelIndex];
      navigator.clipboard.writeText(`Check out ${ch.name}: ${window.location.href}#channel-${activeChannelIndex}`);
      showNotification('Link copied to clipboard!');
    }
  };

  // Favorite toggle
  document.getElementById('favoriteBtn').onclick = () => {
    toggleFavorite(activeChannelIndex);
  };

  // Sidebar toggle
  document.getElementById('sidebarBtn').onclick = () => toggleSidebar();

  // Fullscreen change event
  document.addEventListener('fullscreenchange', () => {
    if (document.fullscreenElement) {
      document.getElementById('fullscreenIcon').className = 'fas fa-compress';
      if (window.innerHeight > window.innerWidth && !landscapeMode) {
        enterLandscapeMode();
      }
    } else {
      document.getElementById('fullscreenIcon').className = 'fas fa-expand';
      if (landscapeMode) exitLandscapeMode();
    }
  });

  // Orientation change
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      if (window.innerHeight > window.innerWidth && !landscapeMode) {
        rotateHint.classList.add('show');
      } else {
        rotateHint.classList.remove('show');
      }
    }, 300);
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (landscapeMode) exitLandscapeMode();
      if (document.fullscreenElement) document.exitFullscreen();
    }
    if (e.key === 'f') toggleFullscreenLandscape();
    if (e.key === 'l') { if (landscapeMode) exitLandscapeMode(); else toggleFullscreenLandscape(); }
  });
}

// Toggle control column visibility
function toggleControlColumn() {
  controlColumn.classList.toggle('hidden');
  controlColumnVisible = !controlColumn.classList.contains('hidden');
  if (!controlColumn.classList.contains('hidden')) autoHideControls();
  else clearTimeout(controlAutoHideTimeout);
}

// Auto hide controls
function autoHideControls() {
  clearTimeout(controlAutoHideTimeout);
  controlAutoHideTimeout = setTimeout(() => {
    if (controlColumnVisible) toggleControlColumn();
  }, 5000);
}

// Show controls temporarily
function showControls() {
  if (controlColumn.classList.contains('hidden')) toggleControlColumn();
  autoHideControls();
}

// Toggle fullscreen / landscape
async function toggleFullscreenLandscape() {
  if (!document.fullscreenElement) {
    await document.documentElement.requestFullscreen();
    if (window.innerHeight > window.innerWidth) { enterLandscapeMode(); }
    document.getElementById('fullscreenIcon').className = 'fas fa-compress';
  } else {
    if (landscapeMode) exitLandscapeMode();
    await document.exitFullscreen();
    document.getElementById('fullscreenIcon').className = 'fas fa-expand';
  }
}

// Landscape mode
function enterLandscapeMode() {
  if (!activeVideo) return;
  landscapeMode = true;
  const channel = channels[activeChannelIndex];

  // Clone video
  const landscapeVideo = activeVideo.cloneNode(true);
  landscapeVideo.id = 'landscapeVideo';

  // Attach media
  if (activeVideo._hls && landscapeVideo) {
    activeVideo._hls.detachMedia();
    activeVideo._hls.attachMedia(landscapeVideo);
  } else {
    landscapeVideo.src = activeVideo.src;
  }
  landscapeVideo.play();

  // Append to container
  landscapeContainer.innerHTML = '';
  landscapeContainer.appendChild(landscapeVideo);

  // Update overlay info
  document.getElementById('landscapeChannelName').textContent = channel.name;
  document.getElementById('landscapeChannelDesc').textContent = channel.desc || '';

  document.getElementById('landscapeMode').classList.add('active');
  document.getElementById('feed').style.opacity = '0';
  controlColumn.classList.add('hidden');
  controlToggle.classList.add('hidden');

  // Show rotate hint if in portrait
  if (window.innerHeight > window.innerWidth) {
    rotateHint.classList.add('show');
  }
}

// Exit landscape mode
function exitLandscapeMode() {
  if (!landscapeMode || !activeVideo) return;
  landscapeMode = false;

  const landscapeVideo = document.getElementById('landscapeVideo');

  if (activeVideo._hls && landscapeVideo) {
    activeVideo._hls.detachMedia();
    activeVideo._hls.attachMedia(activeVideo);
  }

  // Transfer playback state
  activeVideo.currentTime = landscapeVideo?.currentTime || activeVideo.currentTime;
  activeVideo.volume = landscapeVideo?.volume || activeVideo.volume;
  activeVideo.muted = landscapeVideo?.muted || activeVideo.muted;
  activeVideo.play();

  if (landscapeVideo) {
    landscapeVideo.pause();
    landscapeVideo.src = '';
    landscapeVideo.remove();
  }
  document.getElementById('landscapeMode').classList.remove('active');
  rotateHint.classList.remove('show');
  document.getElementById('feed').style.opacity = '1';
  controlToggle.classList.remove('hidden');
}

// Show notification
function showNotification(msg) {
  const notif = document.createElement('div');
  notif.style.cssText = `
    position:fixed; top:80px; left:50%; transform:translateX(-50%);
    background:rgba(0,20,40,0.9); color:#0ff; padding:12px 24px; border-radius:30px; z-index:9999;
    backdrop-filter:blur(10px); border:1px solid rgba(0,255,255,0.3); box-shadow:0 5px 25px rgba(0,255,255,0.3);
    animation: fadeInOut 3s ease;
  `;
  notif.textContent = msg;
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}

// Animate notification
const styleSheet = document.createElement('style');
styleSheet.innerHTML = `
@keyframes fadeInOut {
  0%,100% { opacity:0; transform:translateX(-50%) translateY(-20px); }
  20%,80% { opacity:1; transform:translateX(-50%) translateY(0); }
}`;
document.head.appendChild(styleSheet);

// Hash navigation
window.addEventListener('hashchange', () => {
  const hash = window.location.hash;
  if (hash.startsWith('#channel-')) {
    const idx = parseInt(hash.replace('#channel-',''));
    if (!isNaN(idx) && channels[idx]) {
      const section = document.getElementById(`channel-${idx}`);
      if (section) section.scrollIntoView({behavior:'smooth'});
    }
  }
});
if (window.location.hash) {
  setTimeout(() => window.dispatchEvent(new Event('hashchange')), 500);
}

// Initialize controls
function initControls() {
  document.getElementById('modeToggle').onclick = () => {
    document.body.classList.toggle('light-mode');
  };

  document.getElementById('controlToggle').onclick = () => {
    toggleControlColumn();
  };

  document.getElementById('hideControlsBtn').onclick = () => {
    toggleControlColumn();
  };

  // Volume
  const volSlider = document.getElementById('volumeSlider');
  const volBtn = document.getElementById('volumeBtn');
  volSlider.value = localStorage.getItem('tvVolume') || '1';

  volSlider.oninput = () => {
    const v = parseFloat(volSlider.value);
    if (activeVideo) {
      activeVideo.volume = v;
      localStorage.setItem('tvVolume', v);
      updateVolumeIcon(v);
    }
  };
  volBtn.onclick = () => {
    if (activeVideo) {
      if (activeVideo.volume > 0) {
        activeVideo.volume = 0;
        volSlider.value = '0';
      } else {
        activeVideo.volume = 1;
        volSlider.value = '1';
      }
      localStorage.setItem('tvVolume', activeVideo.volume);
      updateVolumeIcon(activeVideo.volume);
    }
  };

  // Quality
  document.getElementById('qualityBtn').onclick = () => {
    document.getElementById('qualityMenu').classList.toggle('show');
  };
  document.querySelectorAll('.quality-item').forEach(item => {
    item.onclick = () => {
      document.querySelectorAll('.quality-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      if (activeVideo) {
        const section = activeVideo.closest('.channel');
        const hls = section._hls;
        if (hls) {
          const q = item.dataset.quality;
          if (q === 'auto') hls.currentLevel = -1;
          else {
            const levelIdx = hls.levels.findIndex(l => l.height == q);
            if (levelIdx !== -1) hls.currentLevel = levelIdx;
          }
        }
      }
      document.getElementById('qualityMenu').classList.remove('show');
    };
  });
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#qualityBtn') && !e.target.closest('#qualityMenu')) {
      document.getElementById('qualityMenu').classList.remove('show');
    }
  });

  // Fullscreen / Landscape
  document.getElementById('fullscreenLandscapeBtn').onclick = toggleFullscreenLandscape;

  // Landscape controls
  document.getElementById('landscapeExitBtn').onclick = () => {
    if (document.fullscreenElement) document.exitFullscreen();
    if (landscapeMode) exitLandscapeMode();
  };
  document.getElementById('landscapeVolumeBtn').onclick = () => {
    const v = document.getElementById('landscapeVideo');
    if (v) {
      if (v.volume > 0) v.volume = 0;
      else v.volume = 1;
    }
  };

  // Stream info toggle
  document.getElementById('infoBtn').onclick = () => {
    document.getElementById('infoBtn').classList.toggle('active');
    document.getElementById('streamInfo').classList.toggle('show');
    document.getElementById('streamInfo').setAttribute('aria-hidden', String(!document.getElementById('streamInfo').classList.contains('show')));
  };

  // Sleep Timer
  document.getElementById('sleepBtn').onclick = () => {
    sleepPanel.classList.toggle('show');
  };
  document.querySelectorAll('.timer-btn[data-minutes]').forEach(btn => {
    btn.onclick = () => {
      setSleepTimer(parseInt(btn.dataset.minutes));
      sleepPanel.classList.remove('show');
    };
  });
  document.getElementById('setCustomTimer').onclick = () => {
    const val = parseInt(document.getElementById('customTimer').value);
    if (val > 0) setSleepTimer(val);
    sleepPanel.classList.remove('show');
  };
  document.getElementById('cancelTimer').onclick = () => {
    clearTimeout(sleepTimer);
    sleepTimer = null;
    clearInterval(countdownInterval);
    document.getElementById('sleepCountdown').textContent = '';
    showNotification('Sleep timer canceled');
  };

  // Share
  document.getElementById('shareBtn').onclick = () => {
    if (navigator.share && channels[activeChannelIndex]) {
      const ch = channels[activeChannelIndex];
      navigator.share({ title: `Watch ${ch.name} Live`, text: ch.desc, url: window.location.href + '#channel-' + activeChannelIndex });
    } else {
      const ch = channels[activeChannelIndex];
      navigator.clipboard.writeText(`Check out ${ch.name}: ${window.location.href}#channel-${activeChannelIndex}`);
      showNotification('Link copied to clipboard!');
    }
  };

  // Favorite
  document.getElementById('favoriteBtn').onclick = () => toggleFavorite(activeChannelIndex);

  // Sidebar toggle
  document.getElementById('sidebarBtn').onclick = () => toggleSidebar();

  // Fullscreen change
  document.addEventListener('fullscreenchange', () => {
    if (document.fullscreenElement) {
      document.getElementById('fullscreenIcon').className = 'fas fa-compress';
      if (window.innerHeight > window.innerWidth && !landscapeMode) enterLandscapeMode();
    } else {
      document.getElementById('fullscreenIcon').className = 'fas fa-expand';
      if (landscapeMode) exitLandscapeMode();
    }
  });

  // Orientation change
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      if (window.innerHeight > window.innerWidth && !landscapeMode) rotateHint.classList.add('show');
      else rotateHint.classList.remove('show');
    }, 300);
  });
}

// Toggle control column
function toggleControlColumn() {
  controlColumn.classList.toggle('hidden');
  controlColumnVisible = !controlColumn.classList.contains('hidden');
  if (!controlColumn.classList.contains('hidden')) autoHideControls();
}

// Show controls temporarily
function autoHideControls() {
  clearTimeout(controlAutoHideTimeout);
  controlAutoHideTimeout = setTimeout(() => {
    if (controlColumnVisible) toggleControlColumn();
  }, 5000);
}

// Set sleep timer with countdown
function setSleepTimer(minutes) {
  clearTimeout(sleepTimer);
  clearInterval(countdownInterval);
  let secondsLeft = minutes * 60;
  sleepTimer = setTimeout(() => {
    if (activeVideo) {
      activeVideo.pause();
      showNotification(`Sleep timer: Player paused after ${minutes} minutes`);
    }
  }, minutes * 60000);
  document.getElementById('sleepCountdown').textContent = `Time remaining: ${minutes} min`;
  countdownInterval = setInterval(() => {
    secondsLeft--;
    const m = Math.floor(secondsLeft/60);
    const s = secondsLeft % 60;
    document.getElementById('sleepCountdown').textContent = `Time remaining: ${m}m ${s}s`;
    if (secondsLeft <= 0) {
      clearInterval(countdownInterval);
    }
  }, 1000);
}

// Toggle fullscreen / landscape mode
async function toggleFullscreenLandscape() {
  if (!document.fullscreenElement) {
    await document.documentElement.requestFullscreen();
    if (window.innerHeight > window.innerWidth) enterLandscapeMode();
    document.getElementById('fullscreenIcon').className = 'fas fa-compress';
  } else {
    if (landscapeMode) exitLandscapeMode();
    await document.exitFullscreen();
    document.getElementById('fullscreenIcon').className = 'fas fa-expand';
  }
}

// Enter landscape mode
function enterLandscapeMode() {
  if (!activeVideo) return;
  landscapeMode = true;
  const channel = channels[activeChannelIndex];

  const landscapeVideo = activeVideo.cloneNode(true);
  landscapeVideo.id = 'landscapeVideo';

  if (activeVideo._hls) {
    activeVideo._hls.detachMedia();
    activeVideo._hls.attachMedia(landscapeVideo);
  } else {
    landscapeVideo.src = activeVideo.src;
  }
  landscapeVideo.play();

  // Append to container
  landscapeContainer.innerHTML = '';
  landscapeContainer.appendChild(landscapeVideo);

  // Info overlay
  document.getElementById('landscapeChannelName').textContent = channel.name;
  document.getElementById('landscapeChannelDesc').textContent = channel.desc || '';

  document.getElementById('landscapeMode').classList.add('active');
  document.getElementById('feed').style.opacity = '0';
  controlColumn.classList.add('hidden');
  controlToggle.classList.add('hidden');

  if (window.innerHeight > window.innerWidth) {
    rotateHint.classList.add('show');
  }
}

// Exit landscape mode
function exitLandscapeMode() {
  if (!landscapeMode || !activeVideo) return;
  landscapeMode = false;
  const landscapeVideo = document.getElementById('landscapeVideo');

  if (activeVideo._hls && landscapeVideo) {
    activeVideo._hls.detachMedia();
    activeVideo._hls.attachMedia(activeVideo);
  }
  activeVideo.currentTime = landscapeVideo?.currentTime || activeVideo.currentTime;
  activeVideo.volume = landscapeVideo?.volume || activeVideo.volume;
  activeVideo.muted = landscapeVideo?.muted || activeVideo.muted;
  activeVideo.play();

  if (landscapeVideo) {
    landscapeVideo.pause();
    landscapeVideo.src = '';
    landscapeVideo.remove();
  }

  document.getElementById('landscapeMode').classList.remove('active');
  rotateHint.classList.remove('show');
  document.getElementById('feed').style.opacity = '1';
  controlToggle.classList.remove('hidden');
}

// Show notification
function showNotification(msg) {
  const notif = document.createElement('div');
  notif.style.cssText = `
    position:fixed; top:80px; left:50%; transform:translateX(-50%);
    background:rgba(0,20,40,0.9); color:#0ff; padding:12px 24px; border-radius:30px; z-index:9999;
    backdrop-filter:blur(10px); border:1px solid rgba(0,255,255,0.3); box-shadow:0 5px 25px rgba(0,255,255,0.3);
    animation: fadeInOut 3s ease;
  `;
  notif.textContent = msg;
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}

// Animate notification
const styleNotif = document.createElement('style');
styleNotif.innerHTML = `
@keyframes fadeInOut {
  0%,100% { opacity:0; transform:translateX(-50%) translateY(-20px); }
  20%,80% { opacity:1; transform:translateX(-50%) translateY(0); }
}`;
document.head.appendChild(styleNotif);

// Channel click hash navigation
window.addEventListener('hashchange', () => {
  const hash = window.location.hash;
  if (hash.startsWith('#channel-')) {
    const idx = parseInt(hash.replace('#channel-',''));
    if (!isNaN(idx) && channels[idx]) {
      const section = document.getElementById(`channel-${idx}`);
      if (section) section.scrollIntoView({ behavior: 'smooth' });
    }
  }
});
if (window.location.hash) {
  setTimeout(() => window.dispatchEvent(new Event('hashchange')), 500);
}
</script>

</body>
</html>
